<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>自动打码</title>
</head>

<body>
  <input type="file" multiple="multiple" id="file">
  <div id="img-container"></div>
  <script src="https://cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
  <script src="./token.js"></script>
  <script src="./index.js"></script>
  <script>
    const imgCon = document.querySelector('#img-container');
    // getToken((r)=>{
    //   token = r.access_token;
    // })
    bindFileInput('file', (base64) => {
      compressImage(base64).then((compressBase64) => {
        base64 = compressBase64.substring(compressBase64.indexOf(',') + 1);
        getImageInfo(base64, 'idcard').then((info) => {
          const data = info.words_result;
          console.log(data);
          if (data.length === 0) return;
          let location = []
          for (const key in data) {
            if (key === '民族' || key === '性别') continue;
            if (data.hasOwnProperty(key)) {
              let element = data[key].location;
              if (key === '住址') {
                element.height /= 2;
                location.push({
                  height: element.height,
                  top: element.top,
                  left: element.left + element.width / 2,
                  width: element.width / 2
                });
                location.push({
                  height: element.height,
                  top: element.top + element.height,
                  left: element.left,
                  width: element.width
                });
              } else if (key === '公民身份号码'){
                location.push(offsetLocation(element, {left: 0.4, right: 0.4}))
              } else if (key === '姓名'){
                location.push(offsetLocation(element, {left: 0.4}))
              } else if (key === '出生'){
                location.push(offsetLocation(element, {left: 0.2}))
              } else {
                location.push(element)
              }
            }
          }
          drawMosaic({
            location,
            base64: compressBase64
          }).then((result) => {
            appendImage(result);
          })
        })
      })
    })
    function appendImage(result) {
      const imgElem = document.createElement('img');
      imgElem.style.width = '400px';
      imgElem.src = result;
      imgCon.appendChild(imgElem);
    }
  </script>
</body>

</html>